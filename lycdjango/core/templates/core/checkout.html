{% extends 'core/base.html' %}
 {% block title %}Checkout{% endblock %} 
{% load static %} 
{% block content %}
<!-- Breadcrumb Start -->
<div class="breadcrumb-wrap">
  <div class="container-fluid">
    <ul class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Inicio</a></li>
      <li class="breadcrumb-item"><a href="#">Productos</a></li>
      <li class="breadcrumb-item active">Checkout</li>
    </ul>
  </div>
</div>
<!-- Breadcrumb End -->

<!-- Checkout Start -->
<div class="checkout">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-8">
        <div class="checkout-inner">
          <div class="billing-address">
            <h2>Direccion de Envio</h2>
            <div class="row">
              <div class="col-md-6">
                <label>Nombre</label>
                <input class="form-control" type="text" placeholder="Nombre" value="{{ user.username|default:'' }}" />
            </div>
            <div class="col-md-6">
                <label>Apellido</label>
                <input class="form-control" type="text" placeholder="Apellido" value="{{ user.last_name|default:'' }}" />
            </div>
            <div class="col-md-6">
                <label>Correo</label>
                <input class="form-control" type="text" placeholder="Correo" value="{{ user.email|default:'' }}" />
            </div>
              <div class="col-md-6">
                <label>Numero de Telefono</label>
                <input class="form-control" type="text" placeholder="Numero de Telefono" value="{{ user.phone }}"/>
              </div>
              <div class="col-md-6">
                <label>Direccion</label>
                <input class="form-control" type="text" placeholder="Direccion" value="{{ user.adress }}" />
              </div>

              <div class="col-md-6">
                <label>Ciudad</label>
                <input class="form-control" type="text" placeholder="Ciudad" value="{{ user.city }}"/>
              </div>



            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="checkout-inner">
          <div class="checkout-summary">
            <h1>Total del Carrito</h1>
            {% for item in cart_items %}
            <p>
              {{ item.product.nombre }}<span>${{ item.total_item_price }}</span>
            </p>
            {% endfor %}
            <p class="sub-total">Sub Total<span>${{ subtotal }}</span></p>
            <p class="ship-cost">
              Costo de Envio<span>${{ gastos_envio.monto }}</span>
            </p>
            <h2>Total de Compra<span>${{ total }}</span></h2>
          </div>

          <div class="checkout-payment">
            <div class="payment-methods">
              <h1>Metodos de Pago</h1>
              <div id="paypal-button-container"></div>
  <script
    data-sdk-integration-source="integrationbuilder_sc"
    src="https://www.paypal.com/sdk/js?client-id=ATjx_SUwXTbLdgCzgm1Z-hsqnwciE1SYAaBXh08VBuRBadAwwybLzA3k-QKZ7uG78FV9wlk4OETc-caq&components=buttons&enable-funding=venmo,paylater"></script>
                
                
              
            </div>
            <div class="checkout-btn">
              <button>Realizar Pedido</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Checkout End -->
<script>
  paypal.Buttons({
  const FUNDING_SOURCES = [
      // EDIT FUNDING SOURCES
        paypal.FUNDING.PAYPAL,
        paypal.FUNDING.PAYLATER,
        paypal.FUNDING.VENMO,
        paypal.FUNDING.CARD
    ];
    FUNDING_SOURCES.forEach(fundingSource => {
      paypal.Buttons({
        fundingSource,

        style: {
          layout: 'vertical',
          shape: 'rect',
          color: (fundingSource == paypal.FUNDING.PAYLATER) ? 'gold' : '',
        },

        createOrder: async (data, actions) => {
          try {
            const response = await fetch("http://localhost:9597/orders", {
              method: "POST"
            });

            const details = await response.json();
            return details.id;
          } catch (error) {
            console.error(error);
            // Handle the error or display an appropriate error message to the user
          }
        },

        

        onApprove: async (data, actions) => {
          try {
            const response = await fetch(`http://localhost:9597/orders/${data.orderID}/capture`, {
              method: "POST"
            });

            const details = await response.json();
            // Three cases to handle:
            //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
            //   (2) Other non-recoverable errors -> Show a failure message
            //   (3) Successful transaction -> Show confirmation or thank you message

            // This example reads a v2/checkout/orders capture response, propagated from the server
            // You could use a different API or structure for your 'orderData'
            const errorDetail = Array.isArray(details.details) && details.details[0];

            if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
              return actions.restart();
              // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
            }

            if (errorDetail) {
              let msg = 'Sorry, your transaction could not be processed.';
              msg += errorDetail.description ? ' ' + errorDetail.description : '';
              msg += details.debug_id ? ' (' + details.debug_id + ')' : '';
              alert(msg);
            }

            // Successful capture! For demo purposes:
            console.log('Capture result', details, JSON.stringify(details, null, 2));
            const transaction = details.purchase_units[0].payments.captures[0];
            alert('Transaction ' + transaction.status + ': ' + transaction.id + 'See console for all available details');
          } catch (error) {
            console.error(error);
            // Handle the error or display an appropriate error message to the user
          }
        },
      }).render("#paypal-button-container");
    })
</script>
{% endblock %}
